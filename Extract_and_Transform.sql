-- STEP 1.1: Set Context & Create DB/Schema/Warehouse
USE ROLE SYSADMIN; 

CREATE OR REPLACE DATABASE ML_ASSIGNMENT_DB;
CREATE OR REPLACE SCHEMA FEATURE_STORE_SCHEMA;

CREATE OR REPLACE WAREHOUSE MY_WH 
  WITH WAREHOUSE_SIZE = 'SMALL' 
  AUTO_SUSPEND = 60 
  AUTO_RESUME = TRUE;

USE WAREHOUSE MY_WH;
USE DATABASE ML_ASSIGNMENT_DB;
USE SCHEMA FEATURE_STORE_SCHEMA;

CREATE OR REPLACE TABLE SALES_DATA (
    ORDER_ID INT,
    CUSTOMER_ID INT,
    SALE_DATE TIMESTAMP_NTZ,
    AMOUNT FLOAT
);

INSERT INTO SALES_DATA (ORDER_ID, CUSTOMER_ID, SALE_DATE, AMOUNT) VALUES
(1, 101, '2023-10-01 10:00:00', 50.00),
(2, 102, '2023-10-01 11:00:00', 120.00),
(3, 101, '2023-10-05 15:30:00', 30.00),
(4, 103, '2023-10-10 09:00:00', 80.00),
(5, 102, '2023-10-15 14:00:00', 200.00);

SELECT * FROM SALES_DATA;


CREATE OR REPLACE DYNAMIC TABLE CUSTOMER_AGGREGATE_FEATURES
TARGET_LAG = '1 hour'
WAREHOUSE = MY_WH
AS
SELECT
    CUSTOMER_ID,
    MAX(SALE_DATE) AS EVENT_TIMESTAMP,
    SUM(AMOUNT) AS TOTAL_LIFETIME_SPEND,
    COUNT(ORDER_ID) AS TOTAL_ORDERS,
    AVG(AMOUNT) AS AVG_ORDER_VALUE
FROM SALES_DATA
GROUP BY CUSTOMER_ID;

SELECT * FROM CUSTOMER_AGGREGATE_FEATURES;
